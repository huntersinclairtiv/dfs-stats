{% load staticfiles %}
<html>
  <head>    
    <meta charset="utf-8">
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">

    <script
      src="https://code.jquery.com/jquery-3.2.1.min.js"
      integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
      crossorigin="anonymous"></script>
 

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
    <style>

    .node rect {
      cursor: move;
      fill-opacity: .9;
      shape-rendering: crispEdges;
    }

    .node text {
      pointer-events: none;
      text-shadow: 0 1px 0 #fff;
    }

    .link {
      fill: none;
      stroke: #000;
      stroke-opacity: .2;
    }

    .link:hover {
      stroke-opacity: .5;
    }

    .datagrid table { border-collapse: collapse; text-align: left; width: 100%; } .datagrid {margin-bottom: 20px; font: normal 12px/150% Courier New, Courier, monospace; background: #fff; overflow: hidden; border: 1px solid #256129; -webkit-border-radius: 3px; -moz-border-radius: 3px; border-radius: 3px; }.datagrid table td, .datagrid table th { padding: 3px 10px; }.datagrid table thead th {background:-webkit-gradient( linear, left top, left bottom, color-stop(0.05, #1C8C14), color-stop(1, #1B4019) );background:-moz-linear-gradient( center top, #1C8C14 5%, #1B4019 100% );filter:progid:DXImageTransform.Microsoft.gradient(startColorstr='#1C8C14', endColorstr='#1B4019');background-color:#1C8C14; color:#FFFFFF; font-size: 16px; font-weight: normal; border-left: 1px solid #0A4006; } .datagrid table thead th:first-child { border: none; }.datagrid table tbody td { color: #00496B; border-left: 1px solid #6FA86D;font-size: 13px;font-weight: normal; }.datagrid table tbody .alt td { background: #E2F4E0; color: #00496B; }.datagrid table tbody td:first-child { border-left: none; }.datagrid table tbody tr:last-child td { border-bottom: none; }.datagrid table tfoot td div { border-top: 1px solid #256129;background: #E1EEF4;} .datagrid table tfoot td { padding: 0; font-size: 10px } .datagrid table tfoot td div{ padding: 2px; }.datagrid table tfoot td ul { margin: 0; padding:0; list-style: none; text-align: right; }.datagrid table tfoot  li { display: inline; }.datagrid table tfoot li a { text-decoration: none; display: inline-block;  padding: 2px 8px; margin: 1px;color: #FFFFFF;border: 1px solid #08570E;-webkit-border-radius: 3px; -moz-border-radius: 3px; border-radius: 3px; background:-webkit-gradient( linear, left top, left bottom, color-stop(0.05, #047800), color-stop(1, #114501) );background:-moz-linear-gradient( center top, #047800 5%, #114501 100% );filter:progid:DXImageTransform.Microsoft.gradient(startColorstr='#047800', endColorstr='#114501');background-color:#047800; }.datagrid table tfoot ul.active, .datagrid table tfoot ul a:hover { text-decoration: none;border-color: #08570E; color: #FFFFFF; background: none; background-color:#335901;}div.dhtmlx_window_active, div.dhx_modal_cover_dv { position: fixed !important; }

    input[type="button" i], input[type="submit" i] {
      border: none;
      background-color: transparent;
      color: #00496B;
      font-size: 13px;
      font-weight: normal;
      cursor: pointer;
    }
    input[type="button" i]:hover, input[type="submit" i]:hover {
      text-decoration: underline;
    }
    .right {
      float: right;
    }
    .left {
      float: left;
    }
    .clearfix {
      clear: both;
    }
    .createbtn {
      margin: 20px;
      font-size: 24px;
    }
    .errormsg{
      color: #ff0000;
    }
    textarea.form-control.file-text-area {
      height:70%;
    }

    .modal-dialog.modal-lg {
      width: 90%;
      height: 90%;
    }
    .modal-dialog.modal-md {
      width: 50%;
      height: 50%;
    }

    @media (min-width: 768px) {
      .modal-dialog.modal-lg {
        width: 90%;
        height: 90%;
      }
    }
    @media (min-width: 768px) {
      .modal-dialog.modal-md {
        width: 50%;
        height: 50%;
      }
    }

    .action-menu {
      position: absolute;
      top: 20px;
      right: 20px;
      z-index: 1;
      width: 50%;
      height: auto;
      border: 2px solid #333;
      padding: 10px 20px 20px 20px;
      background-color: #F2F2F2;

      -moz-border-radius: 6px;
      -webkit-border-radius: 6px;
      border-radius: 6px;

      -webkit-box-shadow: 0 2px 2px 0 #AAA;
      box-shadow: 0 2px 2px 0 #AAA;
    }
    .project-info {
      width: 48%;
      padding: 20px;
    }
    .body-content {
      padding: 20px;
    }
    .data-explore-title {
      padding-top: 10px;
      margin-left: 20px;
    }
    .inset-list {
      margin-top: 0;
      margin-bottom: 0;
    }
    .action-menu b {
      font-weight: bold;
      font-size: 1.1em;
    }
    .explorebtn {
      margin: 20px;
      font-size: 20px;
    }
    textarea.form-control.keywords-text-area {
      height: 60%;
    }
    .footnote {
      font-size: 10px;
      color: #666;
    }
    </style>
    <title>Thinktiv Web Analytics Tool - Project</title>
  </head>
  <body>
    <div class="project-info">
      <h1>Thinktiv Web Analytics Tool</h1>
      <h2>Project: {{project.name}}</h2>
      <h2>Project stats:</h2>
      <ul>
        <li>Number Words: {{project.stats.wordcount}}</li>
        <li>Companys: {{project.stats.companycount}}</li>
        <li>URLs: {{project.stats.urlcount}}</li>
        <li>Custom Attributes: {{project.stats.attributes}}</li>
        <li>Saved Explorations: {{project.stats.explorecount}}</li>
        <li><a href="/static/projects/{{project.name}}/alldata.zip" download>Download All Data</a></li>
      </ul>
    </div>
    <div class="action-menu right">
      <h2>Data Exploration Analysis:</h2>
      <div class="data-explore-title"><b>CAVE</b> Exploration Phases:</div>
      <ul class="cave-list">
        <li><b>C</b>ollect Keywords/Phrases</li>
        <ul class="inset-list">
        <li> a. Enter keyword/phrase set, and discover others related or proceed to "Assess" phase.</li>
        <li> b. Analyze content for common, important, unique, collocated, etc. AND select.</li>
        </ul>
        <li><b>A</b>ssess content for frequency, likelihood of association, and similar metrics.</li>
        <li><b>V</b>isualize result metrics</li>
        <li><b>E</b>xport Excel/CSV or PNG of visualization</li>
      </ul>
      <button class="btn btn-primary explorebtn"  data-toggle="modal" data-target="#startExploreModal">Start New Exploration</button>
    </div>

    <!-- BODY-CONTENT -->
    <div class="body-content">
      <h2>Project Urls:</h2>
      <p>Below are each URL and the resulting processed content used for analysis or available for download.</p>

      <div class="errormsg">{{project.errorMsg}}</div>
      <form action="" method="POST">
      {% csrf_token %}
        <div class="datagrid">
          <table>
            <thead>
              <tr>
                <th>URL</th>
                <th>Company</th>
                {% for attribute in project.attributes %}
                <th>{{attribute}}</th>
                {% endfor %}
                <th>full html</th>
                <th>raw text</th>
                <th>link text</th>
                <th>nav text</th>
                <th>body text</th>
                <th>wordcount</th>
                <th>actions</th>
              </tr>
            </thead>
            <!-- tfoot>
              <tr>
                <td colspan="4">
                  <div id="paging">
                    <ul>
                      <li><a href="#"><span>Previous</span></a></li>
                      <li><a href="#" class="active"><span>1</span></a></li>
                      <li><a href="#"><span>2</span></a></li>
                      <li><a href="#"><span>3</span></a></li>
                      <li><a href="#"><span>4</span></a></li>
                      <li><a href="#"><span>5</span></a></li>
                      <li><a href="#"><span>Next</span></a></li>
                    </ul>
                  </div>
                </td>
              </tr>
            </tfoot -->
            <tbody>
              {% for datarow in project.data %}
                <tr class="{% if forloop.counter|divisibleby:2 %}alt{% else %}normal{% endif %}">
                  <td>
                    {{datarow.url}}
                  </td>
                  <td>
                    {{datarow.company}}
                  </td>
                  {% for attr in datarow.attributevalues %}
                  <td>
                    {{attr}}
                  </td>
                  {% endfor %}
                  <td>
                    <a class="viewfile" href="{{datarow.htmlContent}}" download>view html</a>
                  </td>
                  <td>
                    <a class="viewfile" href="{{datarow.textContent}}" download>view text</a>
                  </td>
                  <td>
                    <a class="viewfile" href="{{datarow.linkContent}}" download>view links</a>
                  </td>
                  <td>
                    <a class="viewfile" href="{{datarow.navContent}}" download>view nav</a>
                  </td>
                  <td>
                    <a class="viewfile" href="{{datarow.bodyContent}}" download>view body</a>
                  </td>
                  <td>
                    {{datarow.wordcount}}
                  </td>
                  <td>
                    <input type='submit' class="rescrape-but" name='rescrap_html' value='rescrap html' />
                    <input type='submit' class="reprocess-but" name='reprocess_html' value='reprocess html' />
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </form>
      <form action="/webscrape/create_project/" method="POST">
        {% csrf_token %}
          <input type="hidden" name="projectname" id="projectname" {% if project.name %}value="{{project.name}}"{% endif %} />
          <input type="hidden" name="overwrite" id="overwrite" value="true" />
          <textarea name="urls" id="urls" style="display:none;">{% if project.sourcedata %}{{project.sourcedata}}{% else %}url,company,attribute1,attribute2{% endif %}</textarea>
          <button type="submit" class="submit btn btn-default scrape-it">RE-SCRAPE ALL URLs</button><br />
          <span>* Warning: this will overwrite all files above.</span>
      </form>

      {% if project.explorations and project.explorations.data|length > 0 %}
      <h2>Saved Data Exploration Analyses:</h2>
      <p>Below are the saved explorations associated with this project.</p>
      <div>
        <div class="datagrid">
          <table>
            <thead>
              <tr>
                {% for colname in project.explorations.colheads %}
                <th>{{colname}}</th>
                {% endfor %}
                <th>actions</th>
              </tr>
            </thead>
            <tbody>
              {% for datarow in project.explorations.data %}
                <tr class="{% if forloop.counter|divisibleby:2 %}alt{% else %}normal{% endif %}">
                  {% for attr in datarow %}
                  <td>
                    {{attr}}
                  </td>
                  {% endfor %}
                  <td>
                    <input type='submit' class="rescrape-but" name='rescrap_html' value='action1' />
                    <input type='submit' class="reprocess-but" name='reprocess_html' value='action2' />
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      {% endif %}
    </div>
    <!-- END BODY-CONTENT -->

    <!-- MODAL Edit File -->    
    <div class="modal fade" id="editModal" tabindex="-1" role="dialog" aria-labelledby="editModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
          <form id="save-file-form" action="" method="POST">
            {% csrf_token %}
            <div class="modal-header">
              <h5 class="modal-title" id="editModalLabel">Edit text file below and click "Save" to commit changes.</h5>
            </div>
            <div class="modal-body">
              <input type="hidden" class="form-control" name="file-path" id="file-path" />
              <div class="form-group">
                <label for="file-text" class="form-control-label">Message:</label>
                <textarea class="form-control file-text-area" name="file-text" id="file-text"></textarea>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
              <button type="submit" id="save-file" class="btn btn-primary">Save</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <!-- END MODAL Edit File -->

    <!-- MODAL Start Explore -->    
    <div class="modal fade" id="startExploreModal" tabindex="-2" role="dialog" aria-labelledby="startExploreLabel" aria-hidden="true">
      <div class="modal-dialog modal-md" role="document">
        <div class="modal-content">
          <form id="start-explore-form" action="" method="POST">
            {% csrf_token %}
            <div class="modal-header">
              <h2 class="modal-title" id="startExploreLabel">Start New Exploration.</h2>
              <h5 class="modal-description">The first phase of data exploration is to collect all keywords/phrases you would like to use for assessing the scraped content.</h5>
              <h5 class="modal-description">If you already know ALL the keywords/phrases you intend to assess then enter them below and click the "Skip to Assess" button.  Otherwise, you can either enter some starter keywords/phrases or leave the list empty to analyze the content unfiltered; and then collect any keywords/phrases you find during analysis of the data to add to your running list for Assessment.</h5>
            </div>
            <div class="modal-body">
              <div class="form-group">
                <label for="explore-name" class="form-control-label">Name for Exploration:</label>
                <input type="text" class="form-control explore-name-input" name="explore-name" id="explore-name" />
                <input type="hidden" name="project-name" value="{{project.name}}" />
              </div>
              <div class="form-group">
                <label for="keywords-text" class="form-control-label">Keywords/Phrases:</label>
                <textarea class="form-control keywords-text-area" name="keywords-text" id="keywords-text"></textarea>
                <span class="footnote">* Keywords/Phrases should be entered either as comma-separated list or 1 per line</span>
              </div>
            </div>
            <div class="modal-footer">
              <input type="hidden" name="form-action" value="collect" id="explore-form-action" />
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
              <button type="button" id="skip-but" class="btn btn-primary explore-buts">Skip to Assess</button>
              <button type="button" id="start-but" class="btn btn-primary explore-buts">Start Collecting</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <!-- END MODAL  Start Explore -->

  <script type="text/javascript">
    var waitingDialog = waitingDialog || (function ($) {
        'use strict';

      // Creating modal dialog's DOM
      var $dialog = $(
        '<div class="modal fade" data-backdrop="static" data-keyboard="false" tabindex="-1" role="dialog" aria-hidden="true" style="padding-top:15%; overflow-y:visible;">' +
        '<div class="modal-dialog modal-md">' +
        '<div class="modal-content">' +
          '<div class="modal-header"><h3 style="margin:0;"></h3></div>' +
          '<div class="modal-body">' +
            '<div class="progress progress-striped active" style="margin-bottom:0;"><div class="progress-bar" style="width: 100%"></div></div>' +
          '</div>' +
        '</div></div></div>');

      return {
        /**
         * Opens our dialog
         * @param message Custom message
         * @param options Custom options:
         * 				  options.dialogSize - bootstrap postfix for dialog size, e.g. "sm", "m";
         * 				  options.progressType - bootstrap postfix for progress bar type, e.g. "success", "warning".
         */
        show: function (message, options) {
          // Assigning defaults
          if (typeof options === 'undefined') {
            options = {};
          }
          if (typeof message === 'undefined') {
            message = 'Loading';
          }
          var settings = $.extend({
            dialogSize: 'm',
            progressType: '',
            onHide: null // This callback runs after the dialog was hidden
          }, options);

          // Configuring dialog
          $dialog.find('.modal-dialog').attr('class', 'modal-dialog').addClass('modal-' + settings.dialogSize);
          $dialog.find('.progress-bar').attr('class', 'progress-bar');
          if (settings.progressType) {
            $dialog.find('.progress-bar').addClass('progress-bar-' + settings.progressType);
          }
          $dialog.find('h3').text(message);
          // Adding callbacks
          if (typeof settings.onHide === 'function') {
            $dialog.off('hidden.bs.modal').on('hidden.bs.modal', function (e) {
              settings.onHide.call($dialog);
            });
          }
          // Opening dialog
          $dialog.modal();
        },
        /**
         * Closes dialog
         */
        hide: function () {
          $dialog.modal('hide');
        }
      };

    })(jQuery);
    
    
    
    
    
    $(document).ready(function() {
      $(".scrape-it").click(function() {
        waitingDialog.show('Please wait while sites are scraped');
        //setTimeout(function () {waitingDialog.hide();}, 2000);
      });

      $(".rescrape-but").click(function(e) {
        e.preventDefault();
        alert("Not implemented yet");
      });
      $(".reprocess-but").click(function(e) {
        e.preventDefault();
        alert("Not implemented yet");
      });

      $.ajaxSetup({ cache: false });
      $(".viewfile").click(function() {
        $.ajax({
           context: this,
           url : this.href,
           dataType: "text",
           success : function (data) {
               $("#file-text").val(data);
               $("#file-path").val(this.href);
               $("#editModal").modal('show');
           }
        });
        return false;
      });

      $("#save-file-form").submit(function(e) {
          var url = "/webscrape/savefile/"; // the script where you handle the form input.
          $.ajax({
            context: this,
            type: "POST",
            url: url,
            data: $("#save-file-form").serialize(), // serializes the form's elements.
            success: function(data)
            {
              if (data.success == 'true') {
                alert("File Saved Successfully"); // show response from the python script.
                $("#editModal").modal('hide');
              } else {
                alert("There was an error: " + data.errorMsg); // show response from the python script.
              }
            }
          });

          e.preventDefault(); // avoid to execute the actual submit of the form.
      });

      $(".explore-buts").click(function(e) {
          var url = "/webscrape/start_explore/"; // the script where you handle the form input.
          if ($(this).attr('id') == 'skip-but') {
            $("#explore-form-action").val("assess");
          } else {
            $("#explore-form-action").val("collect");
          }
          $.ajax({
            context: this,
            type: "POST",
            url: url,
            data: $("#start-explore-form").serialize(), // serializes the form's elements.
            success: function(data)
            {
              if (data.success == 'true') {
                $("#startExploreModal").modal('hide');
                window.location.href = data.page;
              } else {
                alert("There was an error: " + data.errorMsg); // show response from the python script.
              }
            }
          });

          // e.preventDefault(); // avoid to execute the actual submit of the form.
      });


    }); 
  </script>
  </body>
</html>
